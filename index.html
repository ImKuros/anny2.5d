<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shadow Core 2.5D Engine</title>
    
    <!-- Fonte G√≥tica -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* Reset e base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background: #0a050f;
            background-image: radial-gradient(circle at 20% 30%, #1a1020 0%, #0a050f 90%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Cinzel', 'Courier New', monospace;
            position: relative;
        }

        /* Tela de t√≠tulo */
        #title-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(10, 5, 15, 0.85);
            backdrop-filter: blur(8px);
            z-index: 2000;
            transition: opacity 0.8s ease;
        }

        #title-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #title-image {
            max-width: 80%;
            max-height: 60vh;
            border: 3px solid #b07ac0;
            border-radius: 20px;
            box-shadow: 0 0 40px rgba(176, 122, 192, 0.6);
            margin-bottom: 40px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        #start-button {
            background: linear-gradient(145deg, #2a1a2f, #1a0a1f);
            border: 2px solid #b07ac0;
            border-radius: 60px;
            padding: 18px 60px;
            font-family: 'Cinzel', serif;
            font-size: 32px;
            font-weight: bold;
            color: #f0e0ff;
            text-shadow: 0 0 10px #ca8aca, 0 0 20px #b07ac0;
            letter-spacing: 4px;
            cursor: pointer;
            box-shadow: 0 0 30px rgba(176, 122, 192, 0.5);
            transition: all 0.3s ease;
            outline: none;
            backdrop-filter: blur(4px);
        }

        #start-button:hover {
            background: linear-gradient(145deg, #3a2a3f, #2a1a2f);
            border-color: #e0b0e0;
            box-shadow: 0 0 50px #ca8aca;
            transform: scale(1.05);
            color: #ffffff;
        }

        #start-button:active {
            transform: scale(0.95);
        }

        /* Canvas do jogo */
        canvas {
            border: 2px solid #5a4a6a;
            box-shadow: 0 0 30px rgba(170, 130, 200, 0.3);
            border-radius: 8px;
            image-rendering: crisp-edges;
            display: none; /* Inicialmente oculto */
        }

        /* Controles mobile e joystick (inicialmente ocultos) */
        #mobile-controls, #joystick-container {
            display: none;
        }

        /* Quando o jogo estiver ativo, exibe o canvas e os controles */
        body.game-active canvas {
            display: block;
        }

        body.game-active #mobile-controls,
        body.game-active #joystick-container {
            display: block;
        }

        /* Mensagem de erro */
        .error-message {
            position: absolute;
            bottom: 20px;
            color: #c88;
            background: #1a0a1a;
            padding: 10px;
            border-left: 4px solid #a55;
            z-index: 3000;
        }

        /* Estilos do joystick (mantidos iguais) */
        #joystick-container {
            position: fixed;
            bottom: 40px;
            left: 40px;
            width: 120px;
            height: 120px;
            z-index: 10000;
            pointer-events: none;
        }

        #joystick-base {
            width: 120px;
            height: 120px;
            background: rgba(20, 10, 30, 0.7);
            backdrop-filter: blur(4px);
            border-radius: 50%;
            border: 2px solid rgba(176, 122, 192, 0.8);
            box-shadow: 0 0 20px rgba(176, 122, 192, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
            touch-action: none;
        }

        #joystick-handle {
            width: 50px;
            height: 50px;
            background: radial-gradient(circle at 30% 30%, #ca8aca, #7a4a8a);
            border-radius: 50%;
            border: 2px solid #e0b0e0;
            box-shadow: 0 0 15px #b07ac0;
            transition: transform 0.02s;
            pointer-events: none;
        }

        /* Responsividade: telas pequenas */
        @media (max-width: 1024px) {
            #joystick-container {
                display: none; /* Ser√° exibido quando game-active */
            }
            body.game-active #joystick-container {
                display: block;
            }
        }
    </style>
</head>
<body>
    <!-- Tela de t√≠tulo -->
    <div id="title-screen">
        <!-- Substitua o caminho da imagem pela sua capa -->
        <img src="assets/title.png" alt="Shadow Core" id="title-image">
        <button id="start-button">Start</button>
    </div>

    <!-- Canvas do jogo -->
    <canvas id="gameCanvas" width="800" height="600"></canvas>

    <!-- Controles mobile (seus bot√µes) -->
    <div id="mobile-controls">
        <div class="control-grid">
            <div class="control-btn">W</div>
            <div class="control-btn">A</div>
            <div class="control-btn">S</div>
            <div class="control-btn">D</div>
        </div>
    </div>

    <!-- Joystick virtual -->
    <div id="joystick-container">
        <div id="joystick-base">
            <div id="joystick-handle"></div>
        </div>
    </div>

    <script type="module">
        import { Engine } from './js/engine.js';

        // Elementos da tela
        const titleScreen = document.getElementById('title-screen');
        const startBtn = document.getElementById('start-button');
        const canvas = document.getElementById('gameCanvas');
        const body = document.body;

        // Fun√ß√£o para iniciar o jogo
        async function iniciarJogo() {
            try {
                if (!canvas) throw new Error('Canvas n√£o encontrado');
                
                const ctx = canvas.getContext('2d');
                if (!ctx) throw new Error('Contexto 2D n√£o dispon√≠vel');
                
                console.log('üéÆ Iniciando Shadow Core Engine...');
                
                const engine = new Engine(ctx);
                await engine.start();
                
                console.log('‚úÖ Engine inicializada com sucesso');
                
                // Exp√µe para debug (opcional)
                window.engine = engine;
                
            } catch (error) {
                console.error('‚ùå Erro fatal:', error);
                
                // Mostra erro no canvas
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#1a0a1a';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#c88';
                    ctx.font = '14px "Courier New", monospace';
                    ctx.fillText('ERRO: ' + error.message, 50, 100);
                    ctx.fillText('Verifique o console (F12)', 50, 140);
                }
            }
        }

        // Quando o bot√£o Start for clicado
        startBtn.addEventListener('click', () => {
            // Esconde a tela de t√≠tulo
            titleScreen.classList.add('hidden');
            
            // Ativa o modo jogo (exibe canvas e controles)
            body.classList.add('game-active');
            
            // Inicia a engine
            iniciarJogo();
        });

        // C√≥digo do joystick (igual ao seu, mas movido para dentro do m√≥dulo ou mantido global)
        (function() {
            const container = document.getElementById('joystick-container');
            const base = document.getElementById('joystick-base');
            const handle = document.getElementById('joystick-handle');

            if (!base || !handle) return;

            let active = false;
            let startX = 0, startY = 0;
            let currentX = 0, currentY = 0;
            const maxDist = 40;

            const keyState = { w: false, a: false, s: false, d: false };

            function dispatchKey(key, type) {
                const event = new KeyboardEvent(type, {
                    key: key,
                    code: `Key${key.toUpperCase()}`,
                    keyCode: key.charCodeAt(0) - 32,
                    which: key.charCodeAt(0) - 32,
                    bubbles: true
                });
                document.dispatchEvent(event);
            }

            function updateKeysFromVector(dx, dy) {
                const len = Math.sqrt(dx*dx + dy*dy);
                if (len > 0) {
                    dx /= len;
                    dy /= len;
                }

                const deadzone = 0.2;
                const newW = dy < -deadzone;
                const newS = dy > deadzone;
                const newA = dx < -deadzone;
                const newD = dx > deadzone;

                if (newW !== keyState.w) {
                    dispatchKey('w', newW ? 'keydown' : 'keyup');
                    keyState.w = newW;
                }
                if (newS !== keyState.s) {
                    dispatchKey('s', newS ? 'keydown' : 'keyup');
                    keyState.s = newS;
                }
                if (newA !== keyState.a) {
                    dispatchKey('a', newA ? 'keydown' : 'keyup');
                    keyState.a = newA;
                }
                if (newD !== keyState.d) {
                    dispatchKey('d', newD ? 'keydown' : 'keyup');
                    keyState.d = newD;
                }
            }

            function resetKeys() {
                if (keyState.w) dispatchKey('w', 'keyup');
                if (keyState.s) dispatchKey('s', 'keyup');
                if (keyState.a) dispatchKey('a', 'keyup');
                if (keyState.d) dispatchKey('d', 'keyup');
                keyState.w = keyState.s = keyState.a = keyState.d = false;
            }

            function handleStart(e) {
                e.preventDefault();
                active = true;
                const rect = base.getBoundingClientRect();
                const touch = e.touches ? e.touches[0] : e;
                startX = rect.left + rect.width / 2;
                startY = rect.top + rect.height / 2;
                currentX = touch.clientX;
                currentY = touch.clientY;
                updateJoystickPosition();
            }

            function handleMove(e) {
                if (!active) return;
                e.preventDefault();
                const touch = e.touches ? e.touches[0] : e;
                currentX = touch.clientX;
                currentY = touch.clientY;
                updateJoystickPosition();
            }

            function handleEnd(e) {
                e.preventDefault();
                active = false;
                handle.style.transform = `translate(0px, 0px)`;
                resetKeys();
            }

            function updateJoystickPosition() {
                if (!active) return;

                let dx = currentX - startX;
                let dy = currentY - startY;
                const distance = Math.sqrt(dx*dx + dy*dy);

                if (distance > maxDist) {
                    dx = (dx / distance) * maxDist;
                    dy = (dy / distance) * maxDist;
                }

                handle.style.transform = `translate(${dx}px, ${dy}px)`;

                const normX = dx / maxDist;
                const normY = dy / maxDist;
                updateKeysFromVector(normX, normY);
            }

            base.addEventListener('touchstart', handleStart, { passive: false });
            base.addEventListener('touchmove', handleMove, { passive: false });
            base.addEventListener('touchend', handleEnd);
            base.addEventListener('touchcancel', handleEnd);
            base.addEventListener('mousedown', handleStart);
            window.addEventListener('mousemove', (e) => { if (active) handleMove(e); });
            window.addEventListener('mouseup', handleEnd);
        })();
    </script>
</body>
</html>