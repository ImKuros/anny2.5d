// src/api/deepseekProxy.js
// Proxy ultra-seguro para DeepSeek API

import https from 'https';
import crypto from 'crypto';
import CryptoService from '../security/cryptoService.js';
import TokenizationService from '../security/tokenization.js';
import AuditLogger from '../security/auditLogger.js';
import RequestValidator from './requestValidator.js';
import RateLimiter from './rateLimiter.js';
import KeyManagementService from '../security/keyManagement.js';

class DeepSeekProxy {
  constructor() {
      this.apiKey = null;
          this.baseUrl = 'api.deepseek.com';
              this.timeout = 10000;
                  this.maxRetries = 3;
                      this.circuitBreaker = {
                            failures: 0,
                                  lastFailure: null,
                                        open: false
                                            };
                                              }

                                                async initialize() {
                                                    // Carregar API key do ambiente criptografado
                                                        await this.loadApiKey();
                                                            
                                                                // Inicializar serviÃ§os de seguranÃ§a
                                                                    await KeyManagementService.initialize();
                                                                        
                                                                            console.log('ðŸ”’ DeepSeek Proxy inicializado com seguranÃ§a mÃ¡xima');
                                                                              }

                                                                                async loadApiKey() {
                                                                                    try {
                                                                                          // Em produÃ§Ã£o, isso viria do .env.encrypted
                                                                                                this.apiKey = process.env.DEEPSEEK_API_KEY;
                                                                                                      
                                                                                                            if (!this.apiKey) {
                                                                                                                    throw new Error('API Key nÃ£o encontrada');
                                                                                                                          }
                                                                                                                                
                                                                                                                                      // Verificar formato da chave
                                                                                                                                            if (!this.apiKey.match(/^[a-f0-9]{32,}$/i)) {
                                                                                                                                                    throw new Error('Formato de API Key invÃ¡lido');
                                                                                                                                                          }
                                                                                                                                                              } catch (error) {
                                                                                                                                                                    console.error('âŒ Erro ao carregar API Key:', error);
                                                                                                                                                                          throw error;
                                                                                                                                                                              }
                                                                                                                                                                                }

                                                                                                                                                                                  async generateGameContent(userPrompt, userId, metadata = {}) {
                                                                                                                                                                                      const requestId = RequestValidator.generateRequestId();
                                                                                                                                                                                          
                                                                                                                                                                                              try {
                                                                                                                                                                                                    // 1. VALIDAÃ‡ÃƒO DA REQUISIÃ‡ÃƒO
                                                                                                                                                                                                          const validation = RequestValidator.validatePrompt(userPrompt);
                                                                                                                                                                                                                if (!validation.isValid) {
                                                                                                                                                                                                                        await AuditLogger.log('VALIDATION_FAILED', { errors: validation.errors }, userId);
                                                                                                                                                                                                                                throw new Error(`ValidaÃ§Ã£o falhou: ${validation.errors.join(', ')}`);
                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                            // 2. RATE LIMITING
                                                                                                                                                                                                                                                  const rateCheck = await RateLimiter.checkLimit(userId, 'generateGameContent', {
                                                                                                                                                                                                                                                          limit: 30,        // 30 requisiÃ§Ãµes por minuto
                                                                                                                                                                                                                                                                  burstLimit: 50    // mÃ¡ximo 50 em 10 segundos
                                                                                                                                                                                                                                                                        });
                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                    if (!rateCheck.allowed) {
                                                                                                                                                                                                                                                                                            await AuditLogger.log('RATE_LIMITED', rateCheck, userId);
                                                                                                                                                                                                                                                                                                    throw new Error(`Rate limit excedido. Tente novamente em ${rateCheck.retryAfter}ms`);
                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                // 3. CHECK CIRCUIT BREAKER
                                                                                                                                                                                                                                                                                                                      if (this.circuitBreaker.open) {
                                                                                                                                                                                                                                                                                                                              throw new Error('ServiÃ§o temporariamente indisponÃ­vel');
                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                          // 4. TOKENIZAÃ‡ÃƒO DE DADOS SENSÃVEIS
                                                                                                                                                                                                                                                                                                                                                const tokenizedUserId = TokenizationService.tokenize(userId, 24 * 60 * 60 * 1000);
                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                            // 5. PREPARAR PAYLOAD COM MÃNIMO DE DADOS
                                                                                                                                                                                                                                                                                                                                                                  const sanitizedPrompt = validation.sanitized;
                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                              const payload = {
                                                                                                                                                                                                                                                                                                                                                                                      model: 'deepseek-chat',
                                                                                                                                                                                                                                                                                                                                                                                              messages: [
                                                                                                                                                                                                                                                                                                                                                                                                        {
                                                                                                                                                                                                                                                                                                                                                                                                                    role: 'system',
                                                                                                                                                                                                                                                                                                                                                                                                                                content: this.getSystemPrompt(metadata.gameContext)
                                                                                                                                                                                                                                                                                                                                                                                                                                          },
                                                                                                                                                                                                                                                                                                                                                                                                                                                    {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                role: 'user',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            content: sanitizedPrompt
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      temperature: 0.7,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              max_tokens: 500,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      user: tokenizedUserId,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              // Headers de privacidade
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      'x-request-id': requestId,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              'x-content-opt-out': 'training' // Opt-out explÃ­cito
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          // 6. ASSINAR PAYLOAD (integridade)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const signature = CryptoService.createHMAC(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        JSON.stringify(payload),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                KeyManagementService.getCurrentKey()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      );

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // 7. REQUISIÃ‡ÃƒO SEGURA
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const response = await this.makeSecureRequest(payload, signature, requestId);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // 8. LOG DE AUDITORIA (SEM DADOS SENSÃVEIS)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              await AuditLogger.log('API_SUCCESS', {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      requestId,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              tokens: response.usage?.total_tokens,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      model: response.model
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }, userId);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          success: true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  content: response.choices[0].message.content,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          requestId,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  metadata: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            model: response.model,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      tokens: response.usage?.total_tokens
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        } catch (error) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              // Registrar erro
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    await this.handleError(error, requestId, userId);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          throw error;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  async makeSecureRequest(payload, signature, requestId) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      return new Promise((resolve, reject) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const startTime = Date.now();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const options = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                hostname: this.baseUrl,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        port: 443,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                path: '/v1/chat/completions',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        method: 'POST',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                headers: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          'Content-Type': 'application/json',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'Authorization': `Bearer ${this.apiKey}`,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              'X-Request-ID': requestId,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'X-Signature': signature,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  'X-Client-Version': process.env.CLIENT_VERSION || '1.0.0',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'User-Agent': 'Game-Secure-Client/1.0',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      'Accept': 'application/json',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'Accept-Encoding': 'gzip, deflate, br',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          'Connection': 'keep-alive',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'Cache-Control': 'no-cache'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    timeout: this.timeout,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // ForÃ§ar TLS 1.3
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    secureProtocol: 'TLSv1_3_method',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ciphers: 'TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    honorCipherOrder: true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            rejectUnauthorized: true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // FixaÃ§Ã£o de certificado (certificate pinning)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            checkServerIdentity: (host, cert) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // Verificar fingerprint do certificado
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const fingerprint = crypto
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            .createHash('sha256')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        .update(cert.raw)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    .digest('hex');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // Comparar com fingerprints conhecidos
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const trustedFingerprints = process.env.TRUSTED_CERT_FINGERPRINTS?.split(',') || [];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (!trustedFingerprints.includes(fingerprint)) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return new Error('Certificado nÃ£o confiÃ¡vel');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return undefined;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const req = https.request(options, (res) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        let data = '';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const chunks = [];

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        res.on('data', (chunk) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  chunks.push(chunk);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            data += chunk;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            res.on('end', () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const duration = Date.now() - startTime;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          // Verificar resposta
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (res.statusCode === 200) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const response = JSON.parse(data);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          // Verificar assinatura da resposta (se houver)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const responseSignature = res.headers['x-response-signature'];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if (responseSignature) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // Validar...
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // Reset circuit breaker em sucesso
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             